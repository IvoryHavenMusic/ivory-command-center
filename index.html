<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ivory Command Center</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 32px;
      background: #fafafa;
    }
    h1 { margin-bottom: 12px }
    .card {
      background: #f4f6f8;
      border-radius: 10px;
      padding: 16px;
      max-width: 900px;
    }
    .row { margin: 12px 0 }
    button {
      padding: 10px 14px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #eef3ff;
      cursor: pointer;
    }
    input {
      padding: 10px;
      width: 320px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
    }
    .ok { color: #0a7a00 }
    .err { color: #b00020 }
    .muted { opacity: 0.7 }
  </style>
</head>

<body>
  <h1>Ivory Command Center</h1>

  <div id="status" class="card"></div>

  <div id="login" class="card">
    <div class="row"><strong>Sign in</strong></div>

    <div class="row">
      <input id="email" type="email" placeholder="you@email.com" />
      <button id="magic">Send magic link</button>
    </div>

    <div class="row muted">or</div>

    <button id="google">Continue with Google</button>
  </div>

  <div id="app" class="card" style="display:none">
    <div class="row">Signed in as <strong id="user-email"></strong></div>
    <button id="logout">Sign out</button>
  </div>

  <script type="module">
    /* ==============================
       CONFIG – DO NOT GUESS
    ============================== */

    const BASE_PATH = '/ivory-command-center';
    const CALLBACK_PATH = BASE_PATH + '/auth/callback';
    const HOME_PATH = BASE_PATH + '/index.html';

    /* ==============================
       DOM
    ============================== */

    const status = document.getElementById('status');
    const login = document.getElementById('login');
    const app = document.getElementById('app');
    const userEmail = document.getElementById('user-email');

    const log = (msg, cls = '') => {
      const d = document.createElement('div');
      if (cls) d.className = cls;
      d.textContent = msg;
      status.appendChild(d);
    };

    const showAuthed = (email) => {
      login.style.display = 'none';
      app.style.display = '';
      userEmail.textContent = email;
    };

    const showLogin = () => {
      app.style.display = 'none';
      login.style.display = '';
      userEmail.textContent = '';
    };

    /* ==============================
       LOAD SUPABASE (ABSOLUTE)
    ============================== */

    const supabaseModuleUrl =
      `${window.location.origin}${BASE_PATH}/supabase.js`;

    const { supabase } = await import(supabaseModuleUrl);
    log('Supabase loaded', 'ok');

    /* ==============================
       AUTH STATE
    ============================== */

    supabase.auth.onAuthStateChange((event, session) => {
      log(`Auth event: ${event}`);
      if (session?.user?.email) {
        showAuthed(session.user.email);
      } else {
        showLogin();
      }
    });

    /* ==============================
       CALLBACK HANDLER
    ============================== */

    const isCallback = window.location.pathname === CALLBACK_PATH;
    const params = new URLSearchParams(window.location.search);

    if (isCallback && params.has('code')) {
      log('Handling OAuth callback…');

      const { error } = await supabase.auth.exchangeCodeForSession(
        params.get('code')
      );

      if (error) {
        log(error.message, 'err');
      } else {
        log('Session established', 'ok');
      }

      window.location.replace(
        window.location.origin + HOME_PATH
      );
      return;
    }

    /* ==============================
       SESSION CHECK
    ============================== */

    const { data } = await supabase.auth.getSession();

    if (data.session?.user?.email) {
      log('Existing session found', 'ok');
      showAuthed(data.session.user.email);
    } else {
      log('No session');
      showLogin();
    }

    /* ==============================
       ACTIONS
    ============================== */

    document.getElementById('magic').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) return log('Enter an email', 'err');

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo:
            window.location.origin + CALLBACK_PATH
        }
      });

      if (error) log(error.message, 'err');
      else log('Magic link sent', 'ok');
    };

    document.getElementById('google').onclick = async () => {
      await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo:
            window.location.origin + CALLBACK_PATH
        }
      });
    };

    document.getElementById('logout').onclick = async () => {
      await supabase.auth.signOut();
      showLogin();
      log('Signed out');
    };
  </script>
</body>
</html>
