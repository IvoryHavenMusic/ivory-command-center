<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ivory Tracker â€” Auth (Diag)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width: 640px; margin: 40px auto; padding: 0 16px;">
  <h1>Ivory Tracker Login (Diagnostic)</h1>

  <!-- Diagnostic status feed -->
  <div id="diag" style="font-size:14px; line-height:1.35; padding:10px; background:#f7f7f7; border:1px solid #ddd; border-radius:6px;">
    <div><strong>Diag:</strong> page loaded</div>
  </div>

  <script>
    // tiny helper to append lines to the diag box before the module loads
    (function(){
      const d = document.getElementById('diag');
      window.__log = function(msg){ const p=document.createElement('div'); p.textContent=msg; d.appendChild(p); };
      window.__err = function(msg){ const p=document.createElement('div'); p.style.color='#b00020'; p.textContent=msg; d.appendChild(p); };
      window.__ok  = function(msg){ const p=document.createElement('div'); p.style.color='#0b7a0b'; p.textContent=msg; d.appendChild(p); };
    })();
    __log('Diag bootstrap ready');
  </script>

  <!-- Auth UI -->
  <div id="auth-panel" style="margin-top:16px;">
    <p>Sign in with a magic link:</p>
    <input id="email" type="email" placeholder="your@email.com" style="padding:8px; width:100%; max-width: 420px;">
    <button id="email-btn" style="padding:10px 14px; margin-left: 8px; margin-top: 8px;">Send Magic Link</button>

    <div style="margin: 18px 0; opacity:.6;">â€” or â€”</div>

    <!-- HTML onclick calls a global fallback so even if addEventListener fails, this will fire -->
    <button id="google-btn" onclick="window.__googleClick && window.__googleClick()" style="padding:10px 14px;">Continue with Google</button>
  </div>

  <!-- App UI (hidden until authenticated) -->
  <div id="app" style="display:none; margin-top:24px;">
    <p>Signed in as <strong id="user-email"></strong></p>
    <button id="signout-btn" style="padding:8px 12px;">Sign out</button>

    <hr style="margin:24px 0;">
    <h2>ðŸŽµ Music Tracker</h2>
    <p>Auth works. Weâ€™ll wire your tables next.</p>
  </div>

  <p id="status" style="margin-top:16px; min-height:1.2em;"></p>

  <!-- Main module -->
  <script type="module">
    __ok('Module script startingâ€¦');

    // ====== IMPORTANT: GitHub Pages subpath ======
    const mod = await import(`${location.origin}${BASE_PATH}/supabase.js?v=11`);

    function callbackUrl() {
      return `${window.location.origin}${BASE_PATH}/auth/callback`;
    }

    const statusEl   = document.getElementById('status');
    const authPanel  = document.getElementById('auth-panel');
    const appPanel   = document.getElementById('app');
    const userEmailEl= document.getElementById('user-email');
    const setStatus  = (msg) => statusEl.textContent = msg ?? '';

    // Try to import supabase.js and report any errors to the page
    let supabase;
    try {
      __log('Importing ./supabase.js â€¦');
      const mod = await import('./supabase.js');
      supabase = mod.supabase;
      if (!supabase) throw new Error('supabase export missing');
      __ok('Supabase imported OK');
    } catch (e) {
      __err('Failed to import ./supabase.js â†’ ' + (e && e.message ? e.message : e));
      __err('Check that supabase.js has NO <script> tags and sits beside index.html.');
    }

    // Attach handlers (and also expose globals for the HTML onclick fallback)
    async function onEmailClick() {
      const email = document.getElementById('email').value.trim();
      if (!email) return setStatus('Enter an email first.');
      try {
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: callbackUrl() },
        });
        if (error) setStatus(`Magic link error: ${error.message}`);
        else setStatus('Check your email for the magic link.');
        __ok('Email button handler ran');
      } catch (e) {
        __err('Email click exception: ' + e.message);
      }
    }

    async function onGoogleClick() {
      try {
        __log('Google click fired; redirecting to OAuthâ€¦');
        const { error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: callbackUrl() },
        });
        if (error) {
          setStatus(`Google sign-in error: ${error.message}`);
          __err('Google error: ' + error.message);
        } else {
          __ok('Google sign-in initiated (browser will redirect).');
        }
      } catch (e) {
        __err('Google click exception: ' + e.message);
      }
    }

    // Bind both ways
    try {
      document.getElementById('email-btn').addEventListener('click', onEmailClick);
      document.getElementById('google-btn').addEventListener('click', onGoogleClick);
      window.__googleClick = onGoogleClick; // for HTML onclick fallback
      __ok('Event listeners attached');
    } catch (e) {
      __err('Failed to attach listeners: ' + e.message);
    }

    // Handle callback
    async function handleCallbackIfNeeded() {
      const onCallbackPath = window.location.pathname === `${BASE_PATH}/auth/callback`;
      const hasCode = new URL(window.location.href).searchParams.get('code');
      __log(`Path: ${window.location.pathname} | onCallbackPath=${onCallbackPath} | hasCode=${!!hasCode}`);

      if (onCallbackPath && hasCode) {
        setStatus('Finalizing sign-inâ€¦');
        try {
          const { error } = await supabase.auth.exchangeCodeForSession(window.location.href);
          if (error) {
            setStatus(`Session exchange failed: ${error.message}`);
            __err('exchangeCodeForSession error: ' + error.message);
            return;
          }
          window.history.replaceState({}, '', `${BASE_PATH}/`);
          setStatus('');
          __ok('Session exchange complete; route cleaned');
        } catch (e) {
          __err('exchangeCodeForSession exception: ' + e.message);
        }
      }
    }

    async function refreshUI() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
          userEmailEl.textContent = session.user.email ?? '(no email)';
          authPanel.style.display = 'none';
          appPanel.style.display  = '';
          __ok('User session detected: ' + (session.user.email || 'no email'));
        } else {
          authPanel.style.display = '';
          appPanel.style.display  = 'none';
          __log('No session yet');
        }
      } catch (e) {
        __err('refreshUI exception: ' + e.message);
      }
    }

    supabase?.auth?.onAuthStateChange?.((_event, _session) => {
      __log('[auth change] ' + _event);
      refreshUI();
    });

    await handleCallbackIfNeeded();
    await refreshUI();

    __ok('Module boot complete');
  </script>
</body>
</html>
