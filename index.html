<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ivory Command Center â€” Music Release Tracker</title>
<style>
  :root { --ink:#111; --muted:#666; --line:#e9e9e9; --pill:#eee; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; color:var(--ink); }
  h1 { margin: 0 0 16px; }
  .card { border: 1px solid var(--line); border-radius: 12px; padding: 16px; margin: 0 0 16px; background:#fff; }
  .row { display: grid; gap: 8px; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); }
  label { font-size: 12px; color: var(--muted); display:block; margin-bottom:4px; }
  input, select { width:100%; padding:10px; border:1px solid #ccc; border-radius:10px; font-size:14px; }
  button { padding:10px 14px; border:0; border-radius:10px; cursor:pointer; font-weight:600; }
  .primary { background:#111; color:#fff; }
  .ghost { background:#f4f4f4; }
  .flex { display:flex; gap:8px; align-items:center; }
  .right { margin-left:auto; }
  .pill { font-size:12px; padding:4px 10px; background:var(--pill); border-radius:999px; }
  .hint { color:var(--muted); font-size:12px; }
  table { width:100%; border-collapse:collapse; margin-top:8px; }
  th, td { padding:10px; border-bottom:1px solid #f0f0f0; text-align:left; font-size:14px; }
  tr:hover td { background:#fafafa; }
  #toast { position:fixed; left:16px; right:16px; bottom:16px; padding:12px 14px; border-radius:10px; background:#111; color:#fff; display:none; }
</style>
</head>
<body>

<h1>ðŸŽ¹ Ivory Command Center â€” Music Release Tracker</h1>

<!-- Auth -->
<div class="card" id="authCard">
  <div class="row">
    <div><label>Email</label><input id="email" type="email" placeholder="you@example.com" /></div>
    <div><label>Password</label><input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" /></div>
  </div>
  <div class="flex" style="margin-top:12px">
    <button class="primary" id="btnSignIn">Sign in</button>
    <button class="ghost" id="btnSignUp">Create account</button>
    <span class="right pill" id="authState">Signed out</span>
  </div>
  <div class="hint" id="authHint" style="margin-top:8px"></div>
</div>

<!-- App UI -->
<div class="card" id="appCard" style="display:none">
  <div class="flex" style="margin-bottom:8px">
    <strong>Library</strong>
    <input id="q" placeholder="Search title/artistâ€¦" style="margin-left:12px; flex:1" />
    <button class="ghost" id="btnRefresh">Refresh</button>
    <button class="ghost right" id="btnSignOut">Sign out</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Release</th><th>Artist</th><th>Title</th><th>Cat</th><th>Genre</th><th>BPM</th><th>Ver</th><th>Stream</th><th>Video</th><th>Notes</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div class="hint" id="countHint" style="margin-top:6px"></div>
</div>

<div id="toast"></div>

<!-- Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ====== CONFIG (yours) ======
  const SUPABASE_URL = 'https://wlzjymtugtomvittkkjsw.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indsemp5bXR1Z3Rvdm1pdGtranN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNjk4MzgsImV4cCI6MjA3ODg0NTgzOH0.vnHmV1GA--NXLLMWgetoS_AqZFYbHg2gWzMmQAncaME';

  // ====== CLIENT ======
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== DOM REFS ======
  const authCard = document.getElementById('authCard');
  const appCard  = document.getElementById('appCard');
  const authState = document.getElementById('authState');
  const authHint  = document.getElementById('authHint');
  const email = document.getElementById('email');
  const password = document.getElementById('password');
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSignUp = document.getElementById('btnSignUp');
  const btnSignOut = document.getElementById('btnSignOut');
  const q = document.getElementById('q');
  const btnRefresh = document.getElementById('btnRefresh');
  const tbody = document.getElementById('tbody');
  const countHint = document.getElementById('countHint');
  const toast = document.getElementById('toast');

  function shout(msg, ok=false){ toast.textContent = msg; toast.style.display='block'; toast.style.background = ok ? '#0a7d0a' : '#111'; setTimeout(()=>toast.style.display='none', 2500); }

  function showApp(signedIn){
    authState.textContent = signedIn ? 'Signed in' : 'Signed out';
    authCard.style.display = signedIn ? 'none' : '';
    appCard.style.display  = signedIn ? '' : 'none';
  }

  // ====== AUTH HANDLERS ======
  btnSignIn.onclick = async () => {
    try {
      authHint.textContent = 'Signing inâ€¦';
      const { data, error } = await sb.auth.signInWithPassword({
        email: email.value.trim(), password: password.value
      });
      if (error) throw error;
      showApp(true);
      shout('Signed in', true);
      await loadRows();
    } catch (e) {
      authHint.textContent = 'Auth error: ' + e.message;
      shout(e.message);
    }
  };

  btnSignUp.onclick = async () => {
    try {
      authHint.textContent = 'Creating accountâ€¦';
      const { data, error } = await sb.auth.signUp({
        email: email.value.trim(), password: password.value
      });
      if (error) throw error;
      // With email confirmations OFF, youâ€™re signed in immediately.
      showApp(true);
      shout('Account created', true);
      await loadRows();
    } catch (e) {
      authHint.textContent = 'Signup error: ' + e.message;
      shout(e.message);
    }
  };

  btnSignOut.onclick = async () => {
    await sb.auth.signOut();
    showApp(false);
    shout('Signed out', true);
  };

  // Keep UI in sync if session changes
  sb.auth.onAuthStateChange((_evt, session) => {
    const signedIn = !!session;
    showApp(signedIn);
    if (signedIn) loadRows();
  });

  // ====== DATA (READ) ======
  async function loadRows() {
    try {
      const term = (q.value || '').trim();
      let req = sb.from('music_tracker')
        .select('*')
        .order('release_date', { ascending:false })
        .limit(300);

      if (term) {
        req = sb.from('music_tracker')
          .select('*')
          .or(`song_title.ilike.%${term}%,artist.ilike.%${term}%`)
          .order('release_date', { ascending:false })
          .limit(300);
      }

      const { data, error } = await req;
      if (error) throw error;
      render(data || []);
      countHint.textContent = `${(data||[]).length} row(s)`;
    } catch (e) {
      shout('Load error: ' + e.message);
    }
  }

  function render(rows){
    tbody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${r.release_date ?? ''}</td>
         <td>${r.artist ?? ''}</td>
         <td>${r.song_title ?? ''}</td>
         <td>${r.category ?? ''}</td>
         <td>${r.genre ?? ''}</td>
         <td>${r.bpm ?? ''}</td>
         <td>${r.version ?? ''}</td>
         <td>${r.streaming_status ?? ''}</td>
         <td>${r.video_status ?? ''}</td>
         <td>${(r.notes||'').slice(0,40)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // search/refresh
  q.oninput = () => loadRows();
  btnRefresh.onclick = () => loadRows();

  // On first load, decide which card to show
  (async () => {
    const { data: { session } } = await sb.auth.getSession();
    showApp(!!session);
    if (session) loadRows();
  })();
</script>
</body>
</html>
