<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ivory Command Center â€“ Music Tracker</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
  h1 { margin: 0 0 16px; }
  .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 0 0 16px; }
  .row { display: grid; gap: 8px; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); }
  label { font-size: 12px; color: #444; display:block; margin-bottom:4px; }
  input, select, textarea { width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
  textarea { min-height: 72px; }
  button { padding:10px 14px; border:0; border-radius:8px; cursor:pointer; }
  .primary { background:#111; color:#fff; }
  .ghost { background:#f2f2f2; }
  table { width:100%; border-collapse: collapse; font-size:14px; }
  th, td { padding:10px; border-bottom:1px solid #eee; }
  tr:hover td { background:#fafafa; }
  .actions button { margin-right:8px; }
  .pill { font-size:12px; padding:3px 8px; background:#eee; border-radius:999px; }
  .flex { display:flex; gap:8px; align-items:center; }
  .right { margin-left:auto; }
  .hint { color:#666; font-size:12px; }
</style>
</head>
<body>

<h1>ðŸŽ¹ Ivory Command Center â€” Music Release Tracker</h1>

<!-- AUTH CARD -->
<div class="card" id="authCard">
  <div class="row">
    <div>
      <label>Email (for magic link sign-in)</label>
      <input id="email" type="email" placeholder="you@example.com" />
    </div>
  </div>
  <div class="flex" style="margin-top:10px">
    <button class="primary" id="sendLink">Send magic link</button>
    <span class="hint">Youâ€™ll be logged in after clicking the link in your email.</span>
    <span class="right pill" id="authState">Signed out</span>
  </div>
</div>

<!-- FORM CARD -->
<div class="card" id="formCard" style="display:none">
  <h3 id="formTitle">Add new track</h3>
  <div class="row">
    <div><label>Artist</label><input id="artist"/></div>
    <div><label>Song Title</label><input id="song_title"/></div>
    <div><label>Release Date</label><input id="release_date" type="date"/></div>
    <div><label>Category</label>
      <select id="category">
        <option value="">â€”</option>
        <option>Pop</option><option>Rock</option><option>Tropical</option>
        <option>Afrobeat</option><option>EDM</option><option>Country</option>
        <option>Halloween</option><option>Christmas</option>
      </select>
    </div>
    <div><label>Genre</label><input id="genre"/></div>
    <div><label>BPM</label><input id="bpm" type="number"/></div>
    <div><label>Version</label><input id="version"/></div>
    <div><label>Upgraded From</label><input id="version_upgraded_from"/></div>
    <div><label>Streaming Status</label>
      <select id="streaming_status">
        <option value="">â€”</option><option>Draft</option>
        <option>Scheduled</option><option>Released</option>
      </select>
    </div>
    <div><label>Video Status</label>
      <select id="video_status">
        <option value="">â€”</option>
        <option>None</option><option>Short</option><option>Full Video</option><option>Both</option>
      </select>
    </div>
    <div><label>Demo Preference</label><input id="demo_preference"/></div>
    <div><label>Pitch By</label><input id="pitch_by"/></div>
    <div><label>Remaster Needed?</label>
      <select id="remaster_needed"><option value="false">No</option><option value="true">Yes</option></select>
    </div>
    <div style="grid-column:1/-1">
      <label>Notes (max 255)</label>
      <textarea id="notes" maxlength="255"></textarea>
    </div>
  </div>
  <div class="flex" style="margin-top:12px">
    <button class="primary" id="saveBtn">Save</button>
    <button class="ghost" id="resetBtn">Reset</button>
    <span class="right hint" id="saveHint"></span>
  </div>
</div>

<!-- TABLE CARD -->
<div class="card" id="listCard" style="display:none">
  <div class="flex" style="margin-bottom:8px">
    <strong>Library</strong>
    <input id="q" placeholder="Search title/artistâ€¦" style="margin-left:12px; flex:1" />
    <button class="ghost" id="refreshBtn">Refresh</button>
    <span class="right hint" id="countHint"></span>
  </div>
  <table id="tbl">
    <thead>
      <tr>
        <th>Release</th><th>Artist</th><th>Title</th><th>Cat</th><th>Genre</th>
        <th>BPM</th><th>Ver</th><th>Stream</th><th>Video</th><th>Notes</th><th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* --------------------------
   ðŸ”§ Supabase Config
--------------------------- */
const SUPABASE_URL = "https://wlzjymtugtomvittkkjsw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_zFqgZGPf1pNXeFu60YkuWQ_CSs61RbO";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* --------------------------
   ðŸ”§ DOM References
--------------------------- */
const authCard   = document.getElementById('authCard');
const formCard   = document.getElementById('formCard');
const listCard   = document.getElementById('listCard');
const authState  = document.getElementById('authState');
const sendLink   = document.getElementById('sendLink');
const emailInput = document.getElementById('email');
const tblBody    = document.querySelector('#tbl tbody');
const q          = document.getElementById('q');
const countHint  = document.getElementById('countHint');

let editingId = null;

const fields = [
  'artist','song_title','release_date','category','genre','bpm','version',
  'version_upgraded_from','streaming_status','video_status','demo_preference',
  'pitch_by','remaster_needed','notes'
];

function $(id){ return document.getElementById(id); }

/* --------------------------
   ðŸ” Send Magic Link
--------------------------- */
sendLink.onclick = async () => {
  const email = emailInput.value.trim();
  if (!email) return alert("Enter your email");

  const { error } = await sb.auth.signInWithOtp({
    email,
    options: {
      emailRedirectTo: "https://ivoryhavenmusic.github.io/ivory-command-center/",
      shouldCreateUser: true
    }
  });

  if (error) return alert("Auth error: " + error.message);
  alert("Magic link sent! Check your email.");
};

/* --------------------------
   ðŸ” Auth State Change
--------------------------- */
sb.auth.onAuthStateChange((evt, session) => {
  const signedIn = !!session;
  authState.textContent = signedIn ? "Signed in" : "Signed out";
  formCard.style.display = signedIn ? "" : "none";
  listCard.style.display = signedIn ? "" : "none";
  if (signedIn) loadRows();
});

/* --------------------------
   ðŸ“¥ Load Rows
--------------------------- */
async function loadRows() {
  let query = sb.from('music_tracker')
                .select('*')
                .order('release_date', { ascending:false })
                .limit(300);

  const term = q.value.trim();
  if (term) {
    query = sb.from('music_tracker')
      .select('*')
      .or(`song_title.ilike.%${term}%,artist.ilike.%${term}%`)
      .order('release_date',{ascending:false})
      .limit(300);
  }

  const { data, error } = await query;
  if (error) return alert(error.message);
  renderRows(data);
}

/* --------------------------
   ðŸ“„ Render Rows
--------------------------- */
function renderRows(rows){
  tblBody.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
    <td>${r.release_date||""}</td>
    <td>${r.artist||""}</td>
    <td>${r.song_title||""}</td>
    <td>${r.category||""}</td>
    <td>${r.genre||""}</td>
    <td>${r.bpm||""}</td>
    <td>${r.version||""}</td>
    <td>${r.streaming_status||""}</td>
    <td>${r.video_status||""}</td>
    <td>${(r.notes||"").slice(0,40)}</td>
    <td class="actions">
      <button class="ghost" data-edit="${r.id}">Edit</button>
      <button class="ghost" data-del="${r.id}">Del</button>
    </td>`;
    tblBody.appendChild(tr);
  });
  countHint.textContent = `${rows.length} row(s)`;
}

/* --------------------------
   âœï¸ Table Click (Edit/Delete)
--------------------------- */
tblBody.onclick = async (e)=>{
  const id = e.target.dataset.edit || e.target.dataset.del;
  if (!id) return;

  if (e.target.dataset.edit){
    const { data, error } = await sb.from('music_tracker').select('*').eq('id',id).single();
    if (error) return alert(error.message);
    editingId = id;
    $('formTitle').textContent = "Edit track";
    fields.forEach(f=>{ $(f).value = data[f] ?? ""; });
    $('remaster_needed').value = data.remaster_needed ? "true":"false";
    window.scrollTo({top:0,behavior:'smooth'});
  }

  if (e.target.dataset.del){
    if (!confirm("Delete this row?")) return;
    const { error } = await sb.from('music_tracker').delete().eq('id',id);
    if (error) return alert(error.message);
    loadRows();
  }
};

/* --------------------------
   ðŸ”„ Reset Form
--------------------------- */
resetBtn.onclick = ()=>{
  editingId = null;
  $('formTitle').textContent = "Add new track";
  fields.forEach(f=>$(f).value="");
  $('remaster_needed').value = "false";
  $('saveHint').textContent = "";
};

/* --------------------------
   ðŸ’¾ Save Row
--------------------------- */
saveBtn.onclick = async ()=>{
  const payload = Object.fromEntries(fields.map(f=>[f, $(f).value||null]));
  payload.bpm = payload.bpm ? Number(payload.bpm) : null;
  payload.remaster_needed = (payload.remaster_needed === "true");

  $('saveHint').textContent = "Savingâ€¦";

  let resp;
  if (editingId){
    resp = await sb.from('music_tracker')
         .update({...payload, updated_at:new Date().toISOString()})
         .eq('id',editingId)
         .select()
         .single();
  } else {
    resp = await sb.from('music_tracker')
         .insert(payload)
         .select()
         .single();
  }

  if (resp.error){
    $('saveHint').textContent = "Error: "+resp.error.message;
  } else {
    $('saveHint').textContent = "Saved âœ”";
    resetBtn.click();
    loadRows();
  }
  setTimeout(()=> $('saveHint').textContent="", 2000);
};

/* --------------------------
   ðŸ” Search + Refresh
--------------------------- */
q.oninput = ()=>loadRows();
refreshBtn.onclick = ()=>loadRows();

/* --------------------------
   ðŸš€ On Page Load
--------------------------- */
(async ()=>{
  const { data:{session} } = await sb.auth.getSession();
  if (session){
    formCard.style.display="";
    listCard.style.display="";
    loadRows();
  }
})();
</script>

</body>
</html>
