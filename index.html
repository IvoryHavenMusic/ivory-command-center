<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ivory Command Center</title>

  <style>
    :root{
      color-scheme: dark light;
      --bg:#0b0f14;
      --panel:rgba(255,255,255,0.06);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.68);
      --line:rgba(255,255,255,0.12);
      --btn:rgba(255,255,255,0.12);
      --btnHover:rgba(255,255,255,0.18);
      --ok:#40d67f;
      --warn:#ffb020;
      --err:#ff5d5d;
    }
    body{
      margin:0;
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 30% 10%, rgba(64,214,127,0.14), transparent 60%),
        radial-gradient(1200px 600px at 80% 20%, rgba(0,153,255,0.14), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px 16px 40px;}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;}
    .brand h1{margin:0;font-size:18px;letter-spacing:0.2px;}
    .brand p{margin:6px 0 0;font-size:12px;color:var(--muted);}
    .pill{border:1px solid var(--line);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted);background:rgba(255,255,255,0.03);white-space:nowrap;}
    .panel{border:1px solid var(--line);border-radius:14px;background:var(--panel);padding:16px;box-shadow:0 10px 40px rgba(0,0,0,0.25);}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px;}
    button{appearance:none;border:1px solid var(--line);background:var(--btn);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:600;cursor:pointer;}
    button:hover{background:var(--btnHover);}
    button:disabled{opacity:0.55;cursor:not-allowed;}
    .status{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,0.15);font-size:12px;color:var(--muted);line-height:1.35;word-break:break-word;}
    .status .ok{color:var(--ok);font-weight:700;}
    .status .warn{color:var(--warn);font-weight:700;}
    .status .err{color:var(--err);font-weight:700;}
    .hidden{display:none !important;}
    .tiny{margin-top:10px;font-size:12px;color:var(--muted);}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;}
  </style>

  <!-- Supabase JS (v2) UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Your NON-module supabase.js that sets window.supabaseClient -->
  <script src="supabase.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <h1>Ivory Command Center</h1>
        <p>Music release tracker for Ivory Haven + Ivory Ocean</p>
      </div>
      <div class="pill" id="pillEnv">Loading…</div>
    </div>

    <!-- LOGIN PANEL -->
    <div class="panel" id="loginPanel">
      <div><strong>Sign in</strong></div>

      <div class="tiny">
        OAuth returns to the repo base URL (no <code>/auth/callback</code> route needed).
      </div>

      <div class="row">
        <button id="btnGoogle">Continue with Google</button>
      </div>

      <div class="status" id="statusBox">Initializing…</div>
    </div>

    <!-- APP PANEL -->
    <div class="panel hidden" id="appPanel">
      <div class="header" style="margin-bottom: 10px;">
        <div>
          <div><strong>Welcome back</strong></div>
          <div class="tiny" id="userLine"></div>
        </div>
        <div class="row" style="margin:0;">
          <button id="btnLogout">Logout</button>
        </div>
      </div>

      <!-- UI mounts here -->
      <div id="appRoot"></div>
      <div class="status" id="appStatus" style="margin-top:12px;">App not loaded yet.</div>
    </div>
  </div>

  <script>
    (function () {
      // ====== CONFIG ======
      const REPO = "ivory-command-center";

      // Supabase URL config in your dashboard only accepts NO trailing slash.
      const canonicalBase = window.location.origin + "/" + REPO;      // no trailing slash
      const prettyBase    = canonicalBase + "/";                      // with trailing slash (for loading files)

      // Table names (your actual structure)
      const TABLES = {
        songs: "songs",
        tracker: "music_tracker"
      };

      // ====== UI helpers ======
      function setStatus(html){ document.getElementById("statusBox").innerHTML = html; }
      function setAppStatus(html){ document.getElementById("appStatus").innerHTML = html; }
      function setPill(text){ document.getElementById("pillEnv").textContent = text; }

      function showApp(email){
        document.getElementById("loginPanel").classList.add("hidden");
        document.getElementById("appPanel").classList.remove("hidden");
        document.getElementById("userLine").textContent = email ? ("Signed in as " + email) : "Signed in";
      }
      function showLogin(){
        document.getElementById("appPanel").classList.add("hidden");
        document.getElementById("loginPanel").classList.remove("hidden");
      }

      setPill(prettyBase.replace("https://","").replace("http://",""));

      // ====== Supabase client ======
      const supabaseClient = window.supabaseClient;

      if (!supabaseClient) {
        setStatus(
          "<span class='err'>Missing Supabase client.</span><br>" +
          "Your <code>supabase.js</code> must set <code>window.supabaseClient</code>.<br>" +
          "Open <code>/supabase.js</code> directly and confirm it shows the non-module version."
        );
        document.getElementById("btnGoogle").disabled = true;
        return;
      }

      // ====== OAuth return cleanup ======
      async function cleanUrlAfterOAuth(){
        const hasTokenInHash = window.location.hash && window.location.hash.includes("access_token=");
        if (!hasTokenInHash) return;

        await new Promise(r => setTimeout(r, 75));

        try{
          const { data } = await supabaseClient.auth.getSession();
          if (data && data.session) {
            history.replaceState({}, document.title, prettyBase);
          }
        }catch(_){}
      }

      // ====== Button wiring ======
      document.getElementById("btnGoogle").addEventListener("click", async () => {
        try{
          setStatus("<span class='warn'>Redirecting to Google…</span>");
          const { error } = await supabaseClient.auth.signInWithOAuth({
            provider: "google",
            options: {
              redirectTo: canonicalBase
            }
          });
          if (error) throw error;
        }catch(e){
          setStatus("<span class='err'>Login failed:</span> " + (e && e.message ? e.message : String(e)));
        }
      });

      document.getElementById("btnLogout").addEventListener("click", async () => {
        try{
          await supabaseClient.auth.signOut();
          showLogin();
          setStatus("<span class='ok'>Signed out.</span>");
          setAppStatus("App not loaded yet.");
          document.getElementById("appRoot").innerHTML = "";
        }catch(e){
          setStatus("<span class='err'>Logout failed:</span> " + (e && e.message ? e.message : String(e)));
        }
      });

      // ====== Load tracker UI (non-module) ======
      let uiLoaded = false;

      function loadTrackerUI(){
        if (uiLoaded) return;
        uiLoaded = true;

        setAppStatus("<span class='warn'>Loading tracker UI…</span>");

        const uiSrc = prettyBase + "tracker-ui.js";
        const s = document.createElement("script");
        s.src = uiSrc;
        s.onload = () => {
          // tracker-ui.js must define window.initTrackerUI
          if (typeof window.initTrackerUI !== "function") {
            setAppStatus(
              "<span class='err'>tracker-ui.js loaded, but no <code>window.initTrackerUI</code> found.</span><br>" +
              "Fix: in <code>tracker-ui.js</code>, add something like:<br>" +
              "<code>window.initTrackerUI = function(opts){ ... }</code>"
            );
            return;
          }

          try{
            window.initTrackerUI({
              rootId: "appRoot",
              supabase: supabaseClient,
              tables: TABLES
            });
            setAppStatus("<span class='ok'>Tracker UI initialized.</span>");
          }catch(e){
            setAppStatus("<span class='err'>Tracker UI init error:</span> " + (e && e.message ? e.message : String(e)));
          }
        };
        s.onerror = () => {
          setAppStatus(
            "<span class='err'>Could not load tracker UI.</span><br>" +
            "Missing file: <code>" + uiSrc + "</code>"
          );
        };
        document.body.appendChild(s);
      }

      // ====== Bootstrap ======
      (async function bootstrap(){
        setStatus("Checking session…");
        await cleanUrlAfterOAuth();

        try{
          const { data, error } = await supabaseClient.auth.getSession();
          if (error) throw error;

          const session = data && data.session ? data.session : null;

          if (session && session.user) {
            setStatus("<span class='ok'>Authenticated.</span> Loading tracker…");
            showApp(session.user.email);
            loadTrackerUI();
          } else {
            showLogin();
            setStatus(
              "<span class='warn'>Not signed in yet.</span><br>" +
              "Google will redirect back to:<br><code>" + canonicalBase + "</code>"
            );
          }

          supabaseClient.auth.onAuthStateChange(async (event, newSession) => {
            if (event === "SIGNED_IN" && newSession && newSession.user) {
              await cleanUrlAfterOAuth();
              setStatus("<span class='ok'>Signed in.</span> Loading tracker…");
              showApp(newSession.user.email);
              loadTrackerUI();
            }
            if (event === "SIGNED_OUT") {
              showLogin();
              setStatus("<span class='ok'>Signed out.</span>");
            }
          });

        }catch(e){
          setStatus("<span class='err'>Init error:</span> " + (e && e.message ? e.message : String(e)));
        }
      })();

    })();
  </script>
</body>
</html>
