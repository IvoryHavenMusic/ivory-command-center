<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ivory Command Center â€” Releases</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px}
  h1{margin:0 0 16px}
  .card{border:1px solid #ddd;border-radius:10px;padding:16px;margin:0 0 16px}
  .row{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  label{font-size:12px;color:#444;display:block;margin-bottom:4px}
  input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
  button{padding:10px 14px;border:0;border-radius:8px;cursor:pointer;background:#111;color:#fff}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid #eee}
  tr:hover td{background:#fafafa}
  .hint{color:#666;font-size:12px}
</style>
</head>
<body>

<h1>ðŸŽ¹ Ivory Command Center â€” Releases</h1>

<div class="card">
  <div class="row">
    <div><label>Filter</label><input id="q" placeholder="Search title/artistâ€¦" /></div>
    <div><label class="hint">RLS is OFF, so no login needed (dev only).</label></div>
  </div>
  <div style="margin-top:12px"><button id="refreshBtn">Refresh</button></div>
</div>

<div class="card">
  <h3>Add Song</h3>
  <div class="row">
    <div><label>Title</label><input id="s_title" /></div>
    <div><label>Artist</label>
      <select id="s_artist"><option>Ivory Haven</option><option>Ivory Ocean</option></select>
    </div>
    <div><label>BPM</label><input id="s_bpm" type="number" /></div>
    <div><label>Key Root</label><input id="s_key" placeholder="E / F# / Gâ™­" /></div>
    <div><label>Mode</label><select id="s_mode"><option>major</option><option>minor</option></select></div>
    <div><label>Nashville</label><input id="s_nash" placeholder="1-5-6-4" /></div>
  </div>
  <div style="margin-top:8px"><button id="addSongBtn">Add Song</button> <span class="hint" id="songHint"></span></div>
</div>

<div class="card">
  <h3>Add Release</h3>
  <div class="row">
    <div><label>Song</label><select id="r_song"></select></div>
    <div><label>Release Date</label><input id="r_date" type="date" /></div>
    <div><label>Streaming Status</label>
      <select id="r_stream"><option>Draft</option><option>Scheduled</option><option>Released</option></select>
    </div>
    <div><label>Video Status</label>
      <select id="r_video"><option>None</option><option>Short</option><option>Full Video</option><option>Both</option></select>
    </div>
    <div><label>Version</label><input id="r_version" placeholder="v6 / Final" /></div>
    <div><label>ISRC</label><input id="r_isrc" /></div>
  </div>
  <div style="margin-top:8px"><button id="addReleaseBtn">Add Release</button> <span class="hint" id="relHint"></span></div>
</div>

<div class="card">
  <div class="hint" id="countHint"></div>
  <table id="tbl">
    <thead>
      <tr>
        <th>Release</th><th>Artist</th><th>Title</th><th>BPM</th><th>Key</th><th>Mode</th>
        <th>Stream</th><th>Video</th><th>Version</th><th>ISRC</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const q = document.getElementById('q');
const refreshBtn = document.getElementById('refreshBtn');
const tblBody = document.querySelector('#tbl tbody');
const countHint = document.getElementById('countHint');

const s_title = document.getElementById('s_title');
const s_artist = document.getElementById('s_artist');
const s_bpm = document.getElementById('s_bpm');
const s_key = document.getElementById('s_key');
const s_mode = document.getElementById('s_mode');
const s_nash = document.getElementById('s_nash');
const songHint = document.getElementById('songHint');

const r_song = document.getElementById('r_song');
const r_date = document.getElementById('r_date');
const r_stream = document.getElementById('r_stream');
const r_video = document.getElementById('r_video');
const r_version = document.getElementById('r_version');
const r_isrc = document.getElementById('r_isrc');
const relHint = document.getElementById('relHint');

async function loadSongsForSelect() {
  const { data, error } = await sb.from('songs').select('id,title,artist').order('created_at',{ascending:false}).limit(500);
  if (error) { console.error(error); return; }
  r_song.innerHTML = data.map(s => `<option value="${s.id}">${s.artist} â€” ${s.title}</option>`).join('');
}

async function loadReleases() {
  const term = (q.value||'').trim();
  let query = sb.from('v_releases_full').select('*').limit(500).order('release_date',{ascending:false});
  if (term) {
    query = sb.from('v_releases_full')
      .select('*')
      .or(`title.ilike.%${term}%,artist.ilike.%${term}%`)
      .limit(500)
      .order('release_date',{ascending:false});
  }
  const { data, error } = await query;
  if (error) { alert('Load error: '+error.message); return; }
  renderRows(data||[]);
}

function renderRows(rows){
  tblBody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.release_date ?? ''}</td>
      <td>${r.artist ?? ''}</td>
      <td>${r.title ?? ''}</td>
      <td>${r.bpm ?? ''}</td>
      <td>${r.key_root ?? ''}</td>
      <td>${r.mode ?? ''}</td>
      <td>${r.streaming_status ?? ''}</td>
      <td>${r.video_status ?? ''}</td>
      <td>${r.version ?? ''}</td>
      <td>${r.isrc ?? ''}</td>`;
    tblBody.appendChild(tr);
  });
  countHint.textContent = `${rows.length} release(s)`;
}

document.getElementById('addSongBtn').onclick = async ()=>{
  songHint.textContent = 'Savingâ€¦';
  const payload = {
    title: s_title.value.trim(),
    artist: s_artist.value,
    bpm: s_bpm.value ? Number(s_bpm.value) : null,
    key_root: s_key.value.trim() || null,
    mode: s_mode.value,
    nashville: s_nash.value.trim() || null
  };
  if (!payload.title) { songHint.textContent='Title required'; return; }
  const { error } = await sb.from('songs').insert(payload);
  songHint.textContent = error ? ('Error: '+error.message) : 'Saved âœ”';
  if (!error){ s_title.value=''; s_bpm.value=''; s_key.value=''; s_nash.value=''; loadSongsForSelect(); }
  setTimeout(()=> songHint.textContent='', 2000);
};

document.getElementById('addReleaseBtn').onclick = async ()=>{
  relHint.textContent = 'Savingâ€¦';
  const payload = {
    song_id: Number(r_song.value),
    release_date: r_date.value || null,
    streaming_status: r_stream.value,
    video_status: r_video.value,
    version: r_version.value.trim() || null,
    isrc: r_isrc.value.trim() || null
  };
  if (!payload.song_id){ relHint.textContent='Pick a song'; return; }
  const { error } = await sb.from('releases').insert(payload);
  relHint.textContent = error ? ('Error: '+error.message) : 'Saved âœ”';
  if (!error){ r_date.value=''; r_version.value=''; r_isrc.value=''; loadReleases(); }
  setTimeout(()=> relHint.textContent='', 2000);
};

q.oninput = ()=> loadReleases();
refreshBtn.onclick = ()=> loadReleases();

// init
(async ()=>{
  await loadSongsForSelect();
  await loadReleases();
})();
</script>
</body>
</html>
