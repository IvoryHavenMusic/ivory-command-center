<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ivory Tracker Login (Diagnostic)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    #status { padding: 10px; background:#f1f1f1; border-radius:8px; margin-bottom:20px; }
    #auth-panel, #app { display:none; }
    input { padding: 8px; width: 260px; }
    button { padding: 8px 14px; }
  </style>
</head>

<body>
  <h1>Ivory Tracker Login (Diagnostic)</h1>

  <div id="status">Diag: page loaded</div>

  <div id="auth-panel">
    <p>Sign in with a magic link:</p>
    <input id="email" type="email" placeholder="your@email.com" />
    <button onclick="onEmailClick()">Send Magic Link</button>

    <p>â€” or â€”</p>

    <button onclick="onGoogleClick()">Continue with Google</button>
  </div>

  <div id="app">
    <h3>Logged in as: <span id="user-email"></span></h3>
    <p>Welcome to the Ivory Command Center ðŸŽ¹</p>
  </div>

  <script type="module">
    const logBox = document.getElementById('status');
    const _log = (m)=>{ logBox.innerHTML += `<br>${m}`; };
    const _ok  = (m)=>_log(`<span style="color:green">${m}</span>`);
    const _err = (m)=>_log(`<span style="color:crimson">${m}</span>`);

    _ok("Diag bootstrap ready");
    _ok("Module script starting...");

    // ===== GITHUB PAGES SUBPATH =====
    const BASE_PATH = '/ivory-command-center';

    function callbackUrl(){
      return `${location.origin}${BASE_PATH}/auth/callback`;
    }

    // ===== ABSOLUTE IMPORT URL (NO MORE RELATIVE PROBLEMS) =====
    const IMPORT_URL = `${location.origin}${BASE_PATH}/supabase.js?v=13`;
    _ok(`Import URL: ${IMPORT_URL}`);

    let supabase = null;
    let session = null;

    // ===== TRY IMPORTING SUPABASE.JS =====
    try {
      const mod = await import(IMPORT_URL);
      supabase = mod.supabase;
      if (!supabase) throw new Error("supabase export missing");
      _ok("Supabase imported OK âœ”");
    } catch (e) {
      _err("Failed to import supabase.js â†’ " + e.message);
    }

    const authPanel = document.getElementById("auth-panel");
    const appPanel  = document.getElementById("app");
    const emailSpan = document.getElementById("user-email");

    // ===== INITIAL SESSION CHECK =====
    try {
      const { data } = await supabase.auth.getSession();
      session = data.session;
    } catch {}

    if (session?.user?.email) {
      _ok(`Session found: ${session.user.email}`);
      emailSpan.textContent = session.user.email;
      authPanel.style.display = "none";
      appPanel.style.display  = "block";
    } else {
      _ok("No session found");
      authPanel.style.display = "block";
    }

    // ===== HANDLERS =====
    window.onEmailClick = async function(){
      const email = document.getElementById("email").value.trim();
      if (!email) return _err("Enter an email first.");

      try {
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: callbackUrl() }
        });
        if (error) throw error;
        _ok("Magic link sent!");
      } catch (e) {
        _err("Magic link error â†’ " + e.message);
      }
    };

    window.onGoogleClick = async function(){
      try {
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: { redirectTo: callbackUrl() }
        });
        if (error) throw error;
      } catch (e) {
        _err("Google OAuth error â†’ " + e.message);
      }
    };
  </script>
</body>
</html>
