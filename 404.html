<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ivory Tracker Login (Diagnostic)</title>
  <link rel="preconnect" href="https://esm.sh">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:32px}
    .card{background:#f4f6f8;border-radius:10px;padding:14px 16px;max-width:980px}
    .ok{color:#0a7a00}.err{color:#b00020}
    .row{margin:14px 0}
    input{padding:10px;border:1px solid #cbd5e1;border-radius:6px;width:320px}
    button{padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px;background:#eef3ff;cursor:pointer}
    .muted{opacity:.7}
    code{background:#eef2f7;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h1>Ivory Tracker Login (Diagnostic)</h1>

  <div id="status" class="card"></div>

  <div id="auth-panel" class="row">
    <div class="row">Sign in with a magic link:</div>
    <input id="email" type="email" placeholder="your@email.com" />
    <button id="send-link">Send Magic Link</button>

    <div class="row muted">— or —</div>

    <button id="google">Continue with Google</button>
  </div>

  <div id="app" class="row" style="display:none">
    <div class="row">Signed in as: <strong id="user-email"></strong></div>
    <button id="signout">Sign out</button>
  </div>

  <script type="module">
    // ===== GitHub Pages subpath =====
    // Your published site is: https://ivoryhavenmusic.github.io/ivory-command-center/
    const BASE_PATH = '/ivory-command-center';

    // ===== helpers =====
    const statusEl = document.getElementById('status');
    const authPanel = document.getElementById('auth-panel');
    const appPanel  = document.getElementById('app');
    const userEmail = document.getElementById('user-email');

    const log = (msg, ok=false, err=false) => {
      const cls = err ? 'err' : ok ? 'ok' : '';
      statusEl.innerHTML += `<div class="${cls}">${msg}</div>`;
    };

    const setAuthed = (email) => {
      if (email) {
        authPanel.style.display = 'none';
        appPanel.style.display = '';
        userEmail.textContent = email;
      } else {
        appPanel.style.display = 'none';
        authPanel.style.display = '';
        userEmail.textContent = '';
      }
    };

    // IMPORTANT: Use the repo root as the OAuth redirect target.
    // This avoids GitHub Pages 404 rewrites breaking query strings on deep routes.
    const callbackUrl = () => `${window.location.origin}${BASE_PATH}/`;

    // Remove OAuth params from URL after exchange so refreshes are clean
    const cleanUrl = () => `${window.location.origin}${BASE_PATH}/`;

    // ===== page boot =====
    log('Diag: page loaded');
    log(`Path: <code>${location.pathname}</code>`);
    log(`Search: <code>${location.search || '(none)'}</code>`);

    try {
      log('Module script starting…');

      // Cache buster so GitHub Pages doesn’t serve an old supabase.js
      const v = Date.now().toString().slice(-6);

      // Absolute import so it works regardless of current path
      const importUrl = `${BASE_PATH}/supabase.js?v=${v}`;
      const mod = await import(importUrl);

      log(`Import URL: <code>${new URL(importUrl, location.origin)}</code>`);
      const { supabase } = mod;
      log('Supabase imported OK ✅', true);

      supabase.auth.onAuthStateChange((event, session) => {
        log(`[auth] ${event}`);
        if (session?.user?.email) setAuthed(session.user.email);
      });

      // ---- Handle OAuth code on ROOT (this is the key fix) ----
      const params = new URLSearchParams(location.search);
      const hasCode = params.has('code');
      const hasError = params.has('error') || params.has('error_description');

      if (hasError) {
        log(`OAuth returned error: <code>${params.get('error') || ''}</code>`, false, true);
        const desc = params.get('error_description');
        if (desc) log(`Details: <code>${desc}</code>`, false, true);
      }

      if (hasCode) {
        log('OAuth code detected on root ✅', true);
        try {
          // Best practice: let supabase read the full URL for PKCE code exchange
          const { data, error } = await supabase.auth.exchangeCodeForSession(window.location.href);
          if (error) throw error;

          const email = data?.session?.user?.email;
          log(`Code exchanged for session ✅ ${email ? `(user: ${email})` : ''}`, true);

          // Clean the URL so refresh doesn't re-run exchange
          window.history.replaceState({}, document.title, cleanUrl());
        } catch (e) {
          log(`exchangeCodeForSession error: ${e?.message || e}`, false, true);
        }
      }

      // Check if a session already exists (after exchange or from previous login)
      const { data: { session }, error: sessErr } = await supabase.auth.getSession();
      if (sessErr) log(`getSession error: ${sessErr.message}`, false, true);

      if (session?.user?.email) {
        log('Existing session found ✅', true);
        setAuthed(session.user.email);
      } else {
        log('No session found');
        setAuthed(null);
      }

      // ---- Magic link ----
      document.getElementById('send-link').onclick = async () => {
        const email = (document.getElementById('email').value || '').trim();
        if (!email) return log('Enter an email first.', false, true);
        try {
          const { error } = await supabase.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: callbackUrl() }
          });
          if (error) throw error;
          log('Magic link sent. Check your email ✅', true);
        } catch (e) {
          log(`Magic link error: ${e?.message || e}`, false, true);
        }
      };

      // ---- Google OAuth ----
      document.getElementById('google').onclick = async () => {
        try {
          const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: callbackUrl(),
              queryParams: { prompt: 'consent', access_type: 'offline' }
            }
          });
          if (error) throw error;
        } catch (e) {
          log(`Google OAuth error: ${e?.message || e}`, false, true);
        }
      };

      // ---- Sign out ----
      document.getElementById('signout').onclick = async () => {
        await supabase.auth.signOut();
        setAuthed(null);
        log('Signed out.');
      };

    } catch (e) {
      log(`Boot error: ${e?.message || e}`, false, true);
    }
  </script>
</body>
</html>
