<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ivory Tracker Login (Diagnostic)</title>
  <link rel="preconnect" href="https://esm.sh">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:32px}
    .card{background:#f4f6f8;border-radius:10px;padding:14px 16px;max-width:980px}
    .ok{color:#0a7a00}.err{color:#b00020}
    .row{margin:14px 0}
    input{padding:10px;border:1px solid #cbd5e1;border-radius:6px;width:320px}
    button{padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px;background:#eef3ff;cursor:pointer}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <h1>Ivory Tracker Login (Diagnostic)</h1>

  <div id="status" class="card"></div>

  <div id="auth-panel" class="row">
    <div class="row">Sign in with a magic link:</div>
    <input id="email" type="email" placeholder="your@email.com" />
    <button id="send-link">Send Magic Link</button>

    <div class="row muted">— or —</div>

    <button id="google">Continue with Google</button>
  </div>

  <div id="app" class="row" style="display:none">
    <div class="row">Signed in as: <strong id="user-email"></strong></div>
    <button id="signout">Sign out</button>
  </div>

  <script type="module">
    // ===== GitHub Pages subpath =====
    const BASE_PATH = '/ivory-command-center';

    // ===== helpers =====
    const statusEl = document.getElementById('status');
    const authPanel = document.getElementById('auth-panel');
    const appPanel  = document.getElementById('app');
    const userEmail = document.getElementById('user-email');

    const log = (msg, ok=false, err=false) => {
      const cls = err ? 'err' : ok ? 'ok' : '';
      statusEl.innerHTML += `<div class="${cls}">${msg}</div>`;
    };
    const setAuthed = (email) => {
      if (email) {
        authPanel.style.display = 'none';
        appPanel.style.display = '';
        userEmail.textContent = email;
      } else {
        appPanel.style.display = 'none';
        authPanel.style.display = '';
        userEmail.textContent = '';
      }
    };
    const callbackUrl = () =>
      `${window.location.origin}${BASE_PATH}/auth/callback`;

    // ===== page boot =====
    log('Diag: page loaded');
    log('Diag bootstrap ready');

    // ===== import supabase client (cache-busted) =====
    try {
      log('Module script starting…');
      const v = Date.now().toString().slice(-6); // small cache buster
      const mod = await import(`./supabase.js?v=${v}`);
      const { supabase } = mod;
      log(`Import URL: ${new URL(`./supabase.js?v=${v}`, location.href)}`);
      log('Supabase imported OK ✅', true);

      // ===== auth change listener =====
      supabase.auth.onAuthStateChange(async (event, session) => {
        log(`[auth] ${event}`);
        if (session?.user?.email) setAuthed(session.user.email);
      });

      // ===== are we on /auth/callback with a code? =====
      const isCallbackPath = location.pathname.endsWith('/auth/callback') ||
                             location.pathname.endsWith('/auth/callback/');
      const params = new URLSearchParams(location.search);
      const hasCode = params.has('code');

      if (isCallbackPath) {
        log(`Callback path detected: ${location.pathname}`);
        log(`Has code: ${hasCode}`);

        if (hasCode) {
          try {
            // Explicit exchange (reliable on iOS)
            const { data, error } = await supabase.auth.exchangeCodeForSession(params.get('code'));
            if (error) throw error;
            log('Code exchanged for session ✅', true);
          } catch (e) {
            log(`exchangeCodeForSession error: ${e.message || e}`, false, true);
          }
        }

        // Clean up URL, go back to app root
        const dest = `${window.location.origin}${BASE_PATH}/`;
        log(`Redirecting to app: ${dest}`);
        window.location.replace(dest);
        // Stop boot any further on callback page
        throw new Error('Callback handled; stopping further boot');
      }

      // ===== not callback: show current session if any =====
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user?.email) {
        log('Existing session found ✅', true);
        setAuthed(session.user.email);
      } else {
        log('No session found');
        setAuthed(null);
      }

      // ===== UI handlers =====
      document.getElementById('send-link').onclick = async () => {
        const email = (document.getElementById('email').value || '').trim();
        if (!email) return log('Enter an email first.', false, true);
        try {
          const { error } = await supabase.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: callbackUrl() }
          });
          if (error) throw error;
          log('Magic link sent. Check your email ✅', true);
        } catch (e) {
          log(`Magic link error: ${e.message || e}`, false, true);
        }
      };

      document.getElementById('google').onclick = async () => {
        try {
          const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: callbackUrl(),
              queryParams: { prompt: 'consent', access_type: 'offline' }
            }
          });
          if (error) throw error;
          // Supabase will redirect; no further action.
        } catch (e) {
          log(`Google OAuth error: ${e.message || e}`, false, true);
        }
      };

      document.getElementById('signout').onclick = async () => {
        await supabase.auth.signOut();
        setAuthed(null);
        log('Signed out.');
      };
    } catch (e) {
      log(`Boot error: ${e.message || e}`, false, true);
    }
  </script>
</body>
</html>
